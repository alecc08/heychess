# Heychess 
HeyChess is like heycoconut but for.... you guessed it, CHESS!
(To find out more about heycoconut, see https://github.com/heycoconut/heycoconut)

## How to use
Once the app is installed in your workspace, invite the boy into a channel by tagging them. Once the bot is in the channel you can give someone a chess piece (or more) by tagging them and putting chess piece emojis. `e.g. @Raymond :chess_pawn_white: You beat the puzzle!`

You can also tag multiple people to give to more than one person at a time. 

- You can ask HeyChess for the leaderboard stats

![image](https://user-images.githubusercontent.com/14881741/44823924-ffebf080-abd0-11e8-8b92-e5ef62135007.png)

## Slack Request Validation
There are a couple of features implemented to avoid people "spoofing" the requests, or replaying requests multiple times. The first and most basic validation
keeps track of the last event id's processed, and will avoid re-processing any request that was already processed.

The second and most secure way is to use slack's signing secret to validate the signature in the request header. To do this
we re-encrypt the signature by appending the timestamp with the data and encrypting using the slack signing secret given
when registering a bot in a workspace. If this generated signature matches the one sent in the request header, then the request
is determined to be valid.

## Requirements
 - Mongodb server
    - You need to specify these environment variables for the app to connect to the database
    - `MONGO_HOST`: hostname of the mongodb server
    - `MONGO_PORT`: mongo server port to connect to 
    - `MONGO_DB`  : db name
    - `MONGO_USER`: username to use to connect to the db
    - `MONGO_PW`  : password for the `MONGO_USER`
 - Other environment variables
    - `DAILY_COCONUT_LIMIT` : Max number of coconuts anyone can gift in a day
    - `SLACK_BOT_TOKEN`     : The token which was generated by slack for the bot `e.g. xoxb-XXXXXXXXXXXX-XXXXXXXXXXXX-XXXXXXXXXXXXXXXXXX`
    - `SLACK_SIGNING_SECRET`: The signing secret given by slack when registering a bot in a workspace. Used to validate requests.
    
## Adding new commands
Commands are easy to add, all you have to do is:
 - Add a command which extends the abstract coconut command class.
 - You must annotate the class with @Command and specify the EventType to link the Command to. e.g. `@Command(EventType.MESSAGE)`
 - You also need to create a static "getPredicate" function on your class `public static Predicate<SlackRequestDTO> getPredicate()`,
 - Also a static "build" function which returns an instance of your new command. `public static CoconutCommand build(SlackRequestDTO request)`

The *predicate* will decide in addition to the EventType linked to your command when it should be executed based off the request sent by slack.
An example would be to check the text in the message for certain keywords that may trigger your command

By following those steps, your command will be detected at runtime, and be executed by the CoconutCommandManager class at the right moment.

## Slack App Configuration

Get your signing secret from the `Basic Information` section
![image](https://user-images.githubusercontent.com/9341349/45330809-40366180-b535-11e8-990f-779c1f3ff7c6.png)

You can get your `OAuth Access Token` and `Bot User OAuth Access Token` in the `OAuth & Permissions` section
![image](https://user-images.githubusercontent.com/9341349/45330930-d074a680-b535-11e8-892b-e6270d5fcd65.png)

Define these scopes
![image](https://user-images.githubusercontent.com/9341349/45330961-0154db80-b536-11e8-96fa-e47506a5a99a.png)

Define your request URL and Subscribe to bot events in the `Event Subscriptions` section
![image](https://user-images.githubusercontent.com/9341349/45331021-61e41880-b536-11e8-9b35-53cef43bfdeb.png)

![image](https://user-images.githubusercontent.com/9341349/45331285-db303b00-b537-11e8-9a2c-687381e054c5.png)
